<!doctype html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Escanear QR</title>
		<script src="https://unpkg.com/html5-qrcode"></script>
		<style>
			body {
				font-family: system-ui, Arial;
				padding: 16px;
			}
			#reader {
				width: 320px;
				max-width: 100%;
				margin: 0 auto;
			}
		</style>
	</head>
	<body>
		<h2>Escanear QR</h2>
		<div id="reader"></div>

		<script>
			const params = new URLSearchParams(window.location.search);
			const returnUrl = params.get('return');
			const sid = params.get('sid');

			if (!returnUrl) {
				alert('Error: falta returnUrl');
			}

			const qrScanner = new Html5Qrcode('reader');
			let alreadyScanned = false;

			qrScanner
				.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 }, async (decodedText) => {
					if (alreadyScanned) return;
					alreadyScanned = true;

					try {
						await qrScanner.stop();

						const url = new URL(returnUrl);

						url.searchParams.set('sid', sid || '');
						url.searchParams.set('qr', decodedText);

						// volver al Apps Script
						window.location.href = url.toString();
					} catch (e) {
						alert('Error cámara/redirect: ' + e);
						alreadyScanned = false;
					}
				})
				.catch((err) => {
					alert('Error cámara: ' + err);
				});
		</script>
	</body>
</html>
